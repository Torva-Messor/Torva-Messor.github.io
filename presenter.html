<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Hybrid Presenter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/white.min.css">
    <style>.status { padding: 10px; background: #eee; border: 1px solid #999; font-family: monospace; }</style>
</head>
<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <h3>1. BOARD</h3>
                <p>Status: <span id="p-status">Init...</span></p>
                <p class="fragment" data-action="qr">MORPH TO QR</p>
            </section>
            <section>
                <h3>2. VIDEO START</h3>
                <p>Startet Sync auf allen Geräten.</p>
            </section>
            <section>
                <h3>3. AR</h3>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script src="config.js"></script>
    <script>
        const deck = new Reveal();
        deck.initialize({ controls: true, progress: true, hash: true });

        const pubnub = new PubNub({ publishKey: Pub_Nub_api_Publish, subscribeKey: Pub_Nub_api_Subscribe, userId: "presenter" });
        
        let serverOffset = 0;

        // Zeit einmalig beim Start holen
        pubnub.time().then((res) => {
            serverOffset = Math.floor(res.timetoken / 10000) - Date.now();
            document.getElementById('p-status').innerText = "Ready. Offset: " + serverOffset;
        });

        function broadcast() {
            const idx = deck.getIndices();
            let action = "go";
            let startTime = 0;

            // Logik-Mapping
            if(idx.h === 0) {
                action = (idx.f !== undefined && idx.f >= 0) ? "qr" : "go";
            }
            if(idx.h === 1) {
                action = "video";
                // WICHTIG: Wir senden den Zeitpunkt "JETZT" als Startzeitpunkt
                // Die Viewer rechnen dann: (Ihre Zeit - Startzeit) = Video Position
                startTime = Date.now() + serverOffset; 
            }
            if(idx.h === 2) action = "ar";

            pubnub.publish({
                channel: My_Channel_Name,
                message: {
                    slideIndex: idx.h,
                    action: action,
                    startTime: startTime // Nur relevant für Video
                }
            });
        }

        deck.on('slidechanged', broadcast);
        deck.on('fragmentshown', broadcast);
        deck.on('fragmenthidden', broadcast);
    </script>
</body>
</html>
