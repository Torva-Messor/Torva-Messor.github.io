<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PRESENTER - Wissenschaftswoche</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/white.min.css">
    <style>
        #p-status { position: fixed; top: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; z-index: 100; text-align: center; font-family: sans-serif; font-weight: bold; }
        .reveal { margin-top: 60px; }
        .slide-preview { font-size: 0.5em; color: #555; }
    </style>
</head>
<body>

    <div id="p-status">STATUS: <span id="st-txt" style="color:orange">Verbinde...</span></div>

    <div class="reveal">
        <div class="slides">
            <section><h1>0. Start</h1></section>
            <section><h1>1. Definition</h1><p>Binär / Physisch</p></section>
            <section>
                <h1>2. Struktur</h1>
                <p>Position / Ausrichtung (Klick für Animationen!)</p>
                <div class="fragment">1. Position</div>
                <div class="fragment">2. Ausrichtung</div>
                <div class="fragment">3. Timing</div>
            </section>
            <section><h1>3. Fehlerkorrektur</h1><p>Reed-Solomon</p></section>
            <section><h1>4. Level (30%)</h1><p>High Redundancy</p></section>
            <section><h1>5. Geschichte</h1><p>1992 / Go Brett</p></section>
            
            <section style="background: #e0f7fa;">
                <h1>6. VIDEO FEATURE</h1>
                <p style="color:red;">SYNC STARTET AUTOMATISCH</p>
            </section>
            
            <section style="background: #f3e5f5;">
                <h1>7. AR FEATURE</h1>
                <p>WebXR Modell</p>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script src="config.js"></script>

    <script>
        const deck = new Reveal();
        deck.initialize({ controls: true, progress: true, hash: true, fragmentInURL: false });
        const statusTxt = document.getElementById("st-txt");

        const pubnub = new PubNub({
            subscribeKey: Pub_Nub_api_Subscribe,
            publishKey: Pub_Nub_api_Publish,
            userId: "presenter_master"
        });

        pubnub.addListener({
            status: (s) => {
                if (s.category === "PNConnectedCategory") {
                    statusTxt.innerText = "LIVE & VERBUNDEN";
                    statusTxt.style.color = "#00ff00";
                }
            }
        });

        pubnub.subscribe({ channels: [My_Channel_Name] });

        // Funktion zum Senden des Status
        async function broadcastState() {
            const state = deck.getState();
            const idx = state.indexh;
            const frag = state.indexf; // Fragment Index (für Animationen auf Slide 2)
            
            let startT = null;

            // Wenn wir auf Slide 6 (Video) sind, generieren wir den Zeitstempel
            if (idx === 6) {
                try {
                    const t = await pubnub.time();
                    // 800ms Puffer damit alle Geräte bereit sind
                    startT = Math.floor(t.timetoken / 10000) + 800; 
                } catch(e) { startT = Date.now() + 800; }
            }

            pubnub.publish({
                channel: My_Channel_Name,
                message: { 
                    index: idx, 
                    fragment: frag, // Sendet auch, welcher Teil der Slide sichtbar ist
                    startTime: startT 
                },
                storeInHistory: true
            });
        }

        // Event Listener für Slide-Wechsel UND Fragment-Wechsel (Animationen)
        deck.on('slidechanged', broadcastState);
        deck.on('fragmentshown', broadcastState);
        deck.on('fragmenthidden', broadcastState);

    </script>
</body>
</html>
