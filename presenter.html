<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PRESENTER</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/white.min.css">
    <style>
        body { background: #f4f4f4; }
        .controls-area { position: fixed; top: 0; width: 100%; background: #222; color: white; padding: 10px; z-index: 100; display: flex; justify-content: space-between; align-items: center; font-family: monospace; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: red; display: inline-block; }
        .online { background: #0f0; }
        .reveal { margin-top: 50px; }
        /* Vorschau Styling */
        section { border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div class="controls-area">
        <div><span id="dot" class="status-dot"></span> STATUS</div>
        <div id="current-slide-info">Slide 0</div>
    </div>

    <div class="reveal">
        <div class="slides">
            <section><h1>1. Intro</h1></section>
            <section><h1>2. Definition</h1></section>
            <section>
                <h1>3. Struktur (Animiert)</h1>
                <p class="fragment">Klick 1: Position</p>
                <p class="fragment">Klick 2: Ausrichtung</p>
                <p class="fragment">Klick 3: Timing</p>
            </section>
            <section><h1>4. Fehlerkorrektur</h1></section>
            <section><h1>5. Geschichte</h1></section>
            <section style="background: #e3f2fd;">
                <h1>6. VIDEO SYNC</h1>
                <p>Sync startet automatisch</p>
            </section>
            <section style="background: #e8f5e9;">
                <h1>7. AR MODELL</h1>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script src="config.js"></script>

    <script>
        const deck = new Reveal();
        deck.initialize({ controls: true, progress: true, hash: true });

        const pubnub = new PubNub({
            subscribeKey: Pub_Nub_api_Subscribe,
            publishKey: Pub_Nub_api_Publish,
            userId: "presenter_master"
        });

        pubnub.addListener({
            status: (s) => {
                if (s.category === "PNConnectedCategory") {
                    document.getElementById("dot").classList.add("online");
                }
            }
        });
        pubnub.subscribe({ channels: [My_Channel_Name] });

        // Funktion die ALLES sendet (Slide Index UND Fragment Index)
        async function sendUpdate() {
            const state = deck.getState();
            const indices = deck.getIndices();
            
            document.getElementById("current-slide-info").innerText = 
                `Slide ${indices.h} / Step ${indices.f !== undefined ? indices.f : 0}`;

            let startTime = null;
            // Video auf Index 5 (6. Folie)
            if (indices.h === 5) {
                try {
                    const t = await pubnub.time();
                    startTime = Math.floor(t.timetoken / 10000) + 800;
                } catch(e) { startTime = Date.now() + 800; }
            }

            pubnub.publish({
                channel: My_Channel_Name,
                message: { 
                    index: indices.h,
                    fragment: indices.f !== undefined ? indices.f : -1, // Sende -1 wenn keine Animation aktiv ist
                    startTime: startTime
                },
                storeInHistory: true
            });
        }

        // Wir feuern bei JEDER Ã„nderung (Folie oder Animationsschritt)
        deck.on('slidechanged', sendUpdate);
        deck.on('fragmentshown', sendUpdate);
        deck.on('fragmenthidden', sendUpdate);

    </script>
</body>
</html>
