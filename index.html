<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Torva Viewer - Full Presenter Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/black.min.css">

<style>
:root{--accent:#00f2ff;--damage:#ff0033;--bg:#050505;--board-bg:#2b2b2b;--matrix:#0f0;}
body{margin:0;background:var(--bg);overflow:hidden;font-family:monospace;}

#background-layer{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;z-index:1;}

.morph-container{
display:grid;
grid-template-columns:repeat(15,1fr);
grid-template-rows:repeat(15,1fr);
width:55vmin;height:55vmin;
gap:4px;
transform-style:preserve-3d;
perspective:1200px;
}

.dot{width:100%;height:100%;transition:all .4s ease;}

.mode-go{background:var(--board-bg);padding:10px;gap:2px;}
.mode-go .dot{border-radius:50%;transform:scale(.9);}
.mode-go .white{background:#fff;}
.mode-go .black{background:#000;}
.mode-go .hidden{opacity:.1;}

.mode-qr .dot{border-radius:2px;}
.mode-qr .active{background:var(--accent);}
.mode-qr .inactive{background:rgba(255,255,255,.05);transform:scale(.2);}
.mode-qr .damaged{background:var(--damage)!important;box-shadow:0 0 15px var(--damage);}

/* Fancy Morph */
.morphing{animation:flip 1.4s cubic-bezier(.77,0,.18,1) forwards;}
@keyframes flip{
0%{transform:rotateY(0) scale(1);filter:blur(0);}
50%{transform:rotateY(90deg) scale(.8);filter:blur(8px);}
100%{transform:rotateY(180deg) scale(1);filter:blur(0);}
}

.scan-line{
position:absolute;
width:55vmin;height:4px;
background:linear-gradient(to right,transparent,var(--accent),transparent);
animation:scan 1.2s ease forwards;
}
@keyframes scan{
0%{transform:translateY(-30vmin);opacity:1;}
100%{transform:translateY(30vmin);opacity:0;}
}

/* Highlight Styles */
.highlight-finder{outline:3px solid #00ff00;box-shadow:0 0 20px #00ff00;}
.highlight-timing{outline:3px solid yellow;box-shadow:0 0 20px yellow;}
.highlight-format{outline:3px solid #00aaff;box-shadow:0 0 20px #00aaff;}
.highlight-version{outline:3px solid magenta;box-shadow:0 0 20px magenta;}
.highlight-data{outline:2px solid #ffffff;box-shadow:0 0 10px #ffffff;}
.highlight-error{outline:3px solid orange;box-shadow:0 0 20px orange;}

#qr-status-text{
position:absolute;
bottom:6vh;
left:50%;
transform:translateX(-50%);
color:var(--matrix);
background:rgba(0,0,0,.8);
padding:10px;
border:1px solid var(--matrix);
text-align:center;
font-size:.9rem;
white-space:pre-line;
}

#start-overlay{position:fixed;inset:0;background:#000;display:flex;justify-content:center;align-items:center;z-index:999;}
#btn-start{padding:20px 50px;background:transparent;border:1px solid var(--accent);color:var(--accent);cursor:pointer;}

</style>
</head>
<body>

<div id="start-overlay">
<button id="btn-start" onclick="initApp()">INITIALIZE VIEWER</button>
</div>

<div id="background-layer">
<div id="grid" class="morph-container mode-go"></div>
<div id="qr-status-text">> SYNC_READY</div>
</div>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
<script>
const grid=document.getElementById("grid");
const statusText=document.getElementById("qr-status-text");
const dots=[];
let damageStage=0;

for(let i=0;i<225;i++){
const d=document.createElement("div");
d.className="dot";
grid.appendChild(d);
dots.push(d);
}

function renderGo(){
grid.className="morph-container mode-go";
dots.forEach(d=>{
d.className="dot";
let r=Math.random();
if(r>.8)d.classList.add("black");
else if(r>.6)d.classList.add("white");
else d.classList.add("hidden");
});
}

function renderQR(){
grid.className="morph-container mode-qr";
dots.forEach((d,i)=>{
d.className="dot";
const x=i%15;const y=Math.floor(i/15);
const finder=(x<4&&y<4)||(x>10&&y<4)||(x<4&&y>10);
if(finder||Math.random()>.5)d.classList.add("active");
else d.classList.add("inactive");
});
}

function fancyMorph(){
grid.classList.add("morphing");
setTimeout(()=>{
renderQR();
const scan=document.createElement("div");
scan.className="scan-line";
document.getElementById("background-layer").appendChild(scan);
setTimeout(()=>{scan.remove();grid.classList.remove("morphing");},1400);
},700);
}

function renderDamage(){
damageStage++;
dots.filter(d=>d.classList.contains("active"))
.sort(()=>0.5-Math.random())
.slice(0,Math.floor(20*damageStage))
.forEach(d=>d.classList.add("damaged"));
statusText.innerText=
`> ERROR_LEVEL: ${damageStage*10}%
> FINDER_PATTERNS: SECURED
> DATA_RECOVERY: ACTIVE`;
}

function highlight(type){
dots.forEach(d=>{
d.classList.remove(
"highlight-finder","highlight-timing","highlight-format",
"highlight-version","highlight-data","highlight-error"
);
});
if(!type)return;

dots.forEach((d,i)=>{
const x=i%15;const y=Math.floor(i/15);
const finder=(x<4&&y<4)||(x>10&&y<4)||(x<4&&y>10);
const timing=(x===6||y===6);
const format=(y===8||x===8);
const version=(x>10&&y>10);

if(type==="finder"&&finder)d.classList.add("highlight-finder");
if(type==="timing"&&timing)d.classList.add("highlight-timing");
if(type==="format"&&format)d.classList.add("highlight-format");
if(type==="version"&&version)d.classList.add("highlight-version");
if(type==="data"&&!finder&&!timing&&!format&&!version)d.classList.add("highlight-data");
if(type==="error"&&d.classList.contains("damaged"))d.classList.add("highlight-error");
});
}

function initApp(){
document.getElementById("start-overlay").style.display="none";
renderGo();

const pubnub=new PubNub({
subscribeKey:"sub-c-6fdfc9e3-91b8-4f79-b62a-6fd9fc69eff7",
userId:"viewer_"+Math.random()
});

pubnub.addListener({
message:m=>{
const msg=m.message;
if(msg.action==="morph_qr")fancyMorph();
if(msg.action==="damage")renderDamage();
if(msg.action==="heal"){damageStage=0;renderQR();statusText.innerText="> SYNC_READY";}
if(msg.action==="highlight")highlight(msg.feature);
}
});
pubnub.subscribe({channels:["PrasiW.Woche"]});
}
</script>
</body>
</html>
