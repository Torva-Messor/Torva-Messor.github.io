<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Wissenschaftswoche 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/black.min.css">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        /* Steve Jobs Ästhetik: Schwarz, clean, massive Schrift */
        html, body { background-color: #000; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        .reveal h1, .reveal h2, .reveal p { color: #fff; text-transform: none; }
        .highlight { color: #2196F3; font-weight: bold; }
        .big-number { font-size: 3em; font-weight: bold; color: #2196F3; display: block; }
        .sub-text { font-size: 0.5em; color: #888; margin-top: 20px; }

        /* Overlay & UI */
        #start-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        #start-btn { padding: 20px 50px; background: #333; color: white; border: 1px solid #555; border-radius: 50px; font-size: 18px; cursor: pointer; transition: 0.3s; }
        #start-btn:hover { background: #2196F3; border-color: #2196F3; }
        
        /* Vollbild Medien Container */
        .fs-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* AR Button Styling */
        .ar-button { background: white; border-radius: 30px; border: none; padding: 15px 30px; position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); font-weight: bold; color: #000; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        #status { position: fixed; top: 10px; left: 10px; color: #444; font-size: 10px; font-family: monospace; pointer-events: none; z-index: 50; }
    </style>
</head>
<body>

    <div id="start-overlay"><button id="start-btn" onclick="initViewer()">Präsentation beitreten</button></div>
    <div id="status">SYNC: <span id="sync-val">Ready</span></div>

    <div class="reveal">
        <div class="slides">

            <section>
                <h1 class="r-fit-text">QR CODE</h1>
                <p style="color:#666;">Wissenschaftswoche 2026</p>
            </section>

            <section data-auto-animate>
                <h2 style="font-weight: 300;">Physische Darstellung</h2>
                <h1 class="r-fit-text">BINÄRER DATEN</h1>
                [span_4](start_span)<p class="sub-text">Mit Bitmask-Invertierung zur Fehlervermeidung[span_4](end_span)</p>
            </section>

            <section data-auto-animate>
                <h3>Die Anatomie</h3>
                <div style="display: flex; justify-content: space-around; align-items: center; margin-top: 50px;">
                    <div class="fragment fade-up">
                        <div style="width: 100px; height: 100px; border: 10px solid #fff; background: black;"></div>
                        <p>Position</p>
                    </div>
                    <div class="fragment fade-up">
                        <div style="width: 60px; height: 60px; border: 6px solid #666; background: black;"></div>
                        <p>Ausrichtung</p>
                    </div>
                    <div class="fragment fade-up">
                        <div style="width: 100px; height: 10px; background: repeating-linear-gradient(90deg, #fff, #fff 10px, #000 10px, #000 20px);"></div>
                        <p>Timing</p>
                    </div>
                </div>
                [span_5](start_span)<p class="sub-text" style="margin-top: 60px;">Erforderliche Muster für eindeutiges Auslesen[span_5](end_span)</p>
            </section>

            <section>
                <h2 style="color: #888;">Das Problem:</h2>
                <h3>Schmutz & Beschädigung</h3>
                <br>
                <h2 style="color: #2196F3;" class="fragment">Die Lösung:</h2>
                <h1 class="r-fit-text fragment">REED-SOLOMON</h1>
                [span_6](start_span)<p class="fragment">Mathematische Redundanz[span_6](end_span)</p>
            </section>

            <section>
                <h3>Bis zu</h3>
                <span class="r-fit-text highlight">30%</span>
                <h3>Datenverlust</h3>
                [span_7](start_span)<p>Level H (High) ermöglicht Lesbarkeit trotz massiver Schäden[span_7](end_span).</p>
            </section>

            <section>
                <p style="font-size: 1.5em;">1992</p>
                <h1>Masahiro Hara</h1>
                [span_8](start_span)<p style="color: #888;">Inspiriert durch das Brettspiel Go[span_8](end_span)</p>
            </section>

            <section data-background-color="#000">
                <div class="fs-container">
                    <video id="sync-video" playsinline webkit-playsinline preload="auto">
                        <source src="qr-code-pubnub-torva-project.mp4" type="video/mp4">
                    </video>
                </div>
            </section>

            <section data-background-color="#111">
                <div class="fs-container">
                    <model-viewer 
                        id="ar-element" 
                        src="https://modelviewer.dev/shared-assets/models/Astronaut.glb" 
                        ar 
                        ar-modes="webxr scene-viewer quick-look" 
                        camera-controls 
                        auto-rotate
                        style="width: 100vw; height: 80vh;">
                        <button slot="ar-button" class="ar-button">
                            IN AR ANSEHEN
                        </button>
                    </model-viewer>
                </div>
                <p style="position:absolute; bottom: 20px; width: 100%; text-align: center; color: #666; font-size: 12px;">
                    Torva Precision Sync v4 - WebAR Module
                </p>
            </section>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script src="config.js"></script>

    <script>
        // Reveal Config für Zuschauer: Keine Controls, Passiv
        const deck = new Reveal();
        deck.initialize({ 
            controls: false, 
            progress: false, 
            touch: false, 
            transition: 'slide',
            backgroundTransition: 'fade',
            disableLayout: true, // Wichtig für Vollbild Video
            margin: 0
        });
        
        const video = document.getElementById("sync-video");
        const statusVal = document.getElementById("sync-val");
        let serverTimeOffset = 0;
        let currentStartTime = 0;

        // Video Index ist jetzt Slide Nummer 6 (Index 6, da wir bei 0 starten)
        // Checken wir die Reihenfolge: 
        // 0:Title, 1:Binär, 2:Anatomie, 3:Reed-Solomon, 4:30%, 5:History, 6:VIDEO, 7:AR
        const VIDEO_INDEX = 6;

        async function initViewer() {
            document.getElementById("start-overlay").style.display = 'none';
            
            // Video "Silent Unlock" für iOS
            try { video.muted = true; await video.play(); video.pause(); video.currentTime = 0; video.muted = false; } catch(e){}

            const pubnub = new PubNub({ subscribeKey: Pub_Nub_api_Subscribe, userId: "u_" + Math.random().toString(36).substring(7) });
            
            // Time Sync
            const res = await pubnub.time();
            serverTimeOffset = Math.floor(res.timetoken / 10000) - Date.now();

            pubnub.addListener({
                message: (m) => {
                    const msg = m.message;
                    if (msg.index !== undefined) {
                        // Slide Wechsel
                        deck.slide(msg.index);
                        
                        // Wenn es Fragmente (Animationen) gibt
                        if (msg.fragment !== undefined) {
                            // Wir navigieren solange bis wir beim richtigen Fragment sind
                            const currentIndices = deck.getIndices();
                            if(currentIndices.f < msg.fragment) deck.next();
                        }

                        // Video Sync Daten speichern
                        currentStartTime = msg.startTime;
                        
                        // Wenn wir auf der Video Slide sind, Sync starten
                        if (msg.index === VIDEO_INDEX) {
                            syncVideo(true);
                        } else {
                            video.pause(); // Video stoppen auf anderen Slides
                        }
                    }
                }
            });
            pubnub.subscribe({ channels: [My_Channel_Name] });

            // Loop um Video synchron zu halten
            setInterval(() => {
                if(deck.getIndices().h === VIDEO_INDEX) syncVideo(false);
            }, 500);
        }

        function syncVideo(force) {
            if (!currentStartTime) return;
            
            // Berechnung der aktuellen Position im Video basierend auf Serverzeit
            const now = Date.now() + serverTimeOffset;
            const targetTime = (now - currentStartTime) / 1000;
            
            if (targetTime < 0) return; // Video startet erst gleich

            const diff = targetTime - video.currentTime;

            // Harter Sprung bei großer Abweichung (> 0.5s)
            if (force || Math.abs(diff) > 0.5) {
                video.currentTime = targetTime;
            } 
            // Feine Anpassung der Geschwindigkeit bei kleiner Abweichung
            else if (Math.abs(diff) > 0.1) {
                video.playbackRate = diff > 0 ? 1.05 : 0.95;
            } else {
                video.playbackRate = 1.0;
            }

            if (video.paused && targetTime < video.duration) {
                video.play().catch(e => console.log("Autoplay blocked"));
            }
            statusVal.innerText = Math.round(diff * 1000) + "ms";
        }
    </script>
</body>
</html>
