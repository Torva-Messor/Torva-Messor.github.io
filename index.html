<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Torva Hybrid Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/black.min.css">

    <style>
        /* --- CORE LAYOUT --- */
        body { background: #000; margin: 0; overflow: hidden; }
        #start-overlay { position: fixed; inset: 0; background: #000; z-index: 99999; display: flex; justify-content: center; align-items: center; }
        #start-btn { padding: 20px 50px; background: cyan; border: none; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px cyan; }
        #debug { position: fixed; top: 5px; left: 5px; color: lime; font-family: monospace; z-index: 10000; font-size: 10px; pointer-events: none; }

        /* --- VIDEO ENGINE (Overlay + Sync) --- */
        #video-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 500; /* Über Reveal, unter UI */
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
            display: flex; align-items: center; justify-content: center;
        }
        #video-layer.active { opacity: 1; pointer-events: all; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* --- MORPH BOARD STYLES --- */
        :root { --accent: #00f2ff; }
        .morph-container {
            display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(15, 1fr);
            gap: 4px; width: 75vmin; height: 75vmin; margin: 0 auto;
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .dot { width: 100%; height: 100%; border-radius: 50%; transition: all 0.6s ease; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .dot.black { background: radial-gradient(circle at 30% 30%, #444, #000); transform: scale(0.9); }
        .dot.white { background: radial-gradient(circle at 30% 30%, #fff, #bbb); transform: scale(0.9); }
        
        /* QR Mode */
        .mode-qr .dot { border-radius: 0%; transform: scale(1); box-shadow: none; background: #222; }
        .mode-qr .dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .mode-qr .dot.finder { background: #fff; box-shadow: 0 0 15px #fff; z-index: 2; }
    </style>
</head>
<body>

    <div id="start-overlay"><button id="start-btn" onclick="initSystem()">INITIALIZE SYSTEM</button></div>
    <div id="debug">SYNC: <span id="sync-val">IDLE</span></div>

    <div id="video-layer">
        <video id="sync-video" playsinline webkit-playsinline preload="auto">
            <source src="qr-code-pubnub-torva-project.mp4" type="video/mp4">
        </video>
    </div>

    <div class="reveal">
        <div class="slides">
            <section><div id="grid" class="morph-container"></div></section> <section><h2>SYNC ACTIVE</h2></section> <section> <model-viewer src="https://modelviewer.dev/shared-assets/models/Astronaut.glb" ar camera-controls style="width:100vw; height:80vh;"></model-viewer>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script src="config.js"></script>

    <script>
        // 1. SETUP REVEAL
        const deck = new Reveal();
        deck.initialize({ controls: false, progress: false, transition: 'fade', disableLayout: true });

        // 2. SETUP BOARD (Visuals)
        const grid = document.getElementById('grid');
        const dots = [];
        for(let i=0; i<225; i++) {
            let d = document.createElement('div'); d.className = 'dot hidden';
            grid.appendChild(d); dots.push(d);
        }

        function renderVisuals(mode) {
            const vLayer = document.getElementById('video-layer');
            const vid = document.getElementById('sync-video');
            
            // Video Layer Management
            if(mode === 'video') {
                vLayer.classList.add('active');
            } else {
                vLayer.classList.remove('active');
                vid.pause(); // Video stoppen wenn nicht aktiv
                currentSyncStart = 0; // Sync Engine pausieren
            }

            // Board Logic
            if(mode === 'go') {
                grid.classList.remove('mode-qr');
                dots.forEach(d => d.className = Math.random()>0.5 ? 'dot black' : 'dot white');
            } 
            else if(mode === 'qr') {
                grid.classList.add('mode-qr');
                dots.forEach((d, i) => {
                    let x=i%15, y=Math.floor(i/15);
                    let isFinder = (x<4 && y<4) || (x>10 && y<4) || (x<4 && y>10);
                    d.className = isFinder ? 'dot finder' : (Math.random()>0.6 ? 'dot active' : 'dot');
                });
            }
        }

        // 3. HIGH PERFORMANCE SYNC ENGINE
        const video = document.getElementById("sync-video");
        const statusVal = document.getElementById("sync-val");
        let pubnub;
        let serverTimeOffset = 0;
        let currentSyncStart = 0; // Timestamp wann das Video gestartet wurde
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        async function initSystem() {
            document.getElementById("start-overlay").style.display = 'none';
            // Unlock Audio Context
            video.muted = true; 
            try { await video.play(); video.pause(); video.currentTime = 0; video.muted = false; } catch(e){}

            renderVisuals('go'); // Start State

            pubnub = new PubNub({ subscribeKey: Pub_Nub_api_Subscribe, userId: "viewer_" + Math.random() });
            
            // Time Calibration
            const res = await pubnub.time();
            serverTimeOffset = Math.floor(res.timetoken / 10000) - Date.now();
            console.log("Time Offset:", serverTimeOffset);

            pubnub.addListener({
                message: (m) => {
                    const msg = m.message;
                    
                    // Slide Navigation
                    if(msg.slideIndex !== undefined) deck.slide(msg.slideIndex);
                    
                    // Visual Action
                    if(msg.action) renderVisuals(msg.action);

                    // Sync Signal
                    if(msg.action === 'video' && msg.startTime) {
                        currentSyncStart = msg.startTime;
                        // Sofortiger Startversuch für Responsiveness
                        syncLoop(true); 
                    }
                }
            });
            pubnub.subscribe({ channels: [My_Channel_Name] });

            // Start Sync Heartbeat
            setInterval(() => syncLoop(false), 200);
        }

        function syncLoop(force) {
            // Nur syncen, wenn wir im Video-Modus sind und eine Startzeit haben
            if (!currentSyncStart || !document.getElementById('video-layer').classList.contains('active')) return;

            const now = Date.now() + serverTimeOffset;
            const appleComp = isIOS ? 350 : 0; // iOS Buffer Kompensation
            
            // Soll-Zeit berechnen: (Jetzt - Startzeit) = Wie lange läuft das Video schon?
            let targetTime = (now - (currentSyncStart - appleComp)) / 1000;

            if (targetTime < 0) targetTime = 0; // Video sollte noch nicht laufen
            
            const diff = targetTime - video.currentTime;
            statusVal.innerText = Math.round(diff * 1000) + "ms";

            // Logic aus deinem File:
            if (force || Math.abs(diff) > 0.6) {
                // Harter Sprung bei großem Drift
                video.currentTime = targetTime;
                video.playbackRate = 1.0;
            } else if (Math.abs(diff) > 0.05) {
                // Sanfter Pitch wenn Drift klein
                video.playbackRate = diff > 0 ? 1.15 : 0.85; 
            } else {
                video.playbackRate = 1.0;
            }

            if (video.paused) {
                video.play().catch(e => console.log("Autoplay blockiert", e));
            }
        }
    </script>
</body>
</html>
