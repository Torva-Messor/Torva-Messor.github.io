<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Live Präsentation - AR & Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/black.min.css">

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        /* Grund-Design */
        body { margin: 0; background-color: black; color: white; }

        /* Status oben rechts */
        #status-bar {
            position: fixed; top: 10px; right: 10px; z-index: 100;
            padding: 6px 12px; background: rgba(0,0,0,0.8);
            border-radius: 20px; font-family: sans-serif; font-size: 11px;
            border: 1px solid #444; pointer-events: none;
        }

        /* Start-Bildschirm (Wichtig für Audio-Freischaltung) */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; 
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; font-family: sans-serif;
        }

        #start-btn {
            padding: 18px 45px; background: #2196F3; color: white; border: none;
            border-radius: 40px; font-size: 20px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.4); margin-top: 20px;
        }

        /* Folien-Inhalt */
        .reveal img { max-height: 400px !important; border: 2px solid #fff; border-radius: 8px; }
        
        /* AR Viewer Design */
        .ar-container {
            width: 100%;
            height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        model-viewer {
            width: 90%;
            height: 450px;
            background-color: #1a1a1a;
            border-radius: 15px;
            --poster-color: transparent;
        }

        /* Der Button, um die Kamera zu starten */
        .ar-button {
            background-color: #2196F3;
            border-radius: 8px;
            border: none;
            padding: 12px 24px;
            font-weight: bold;
            color: white;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h2>Präsentation beitreten</h2>
        <p>Klicke Start für Audio-Synchronisation & AR</p>
        <button id="start-btn" onclick="initViewer()">START</button>
    </div>

    <div id="status-bar">Status: <span id="st-txt" style="color: #ff9900;">Warte...</span></div>

    <audio id="sync-audio" src="morse (2).mp3" preload="auto"></audio>

    <div class="reveal">
        <div class="slides">
            
            <section>
                <h1>Willkommen</h1>
                <p>Die Präsentation wird vom Host gesteuert.</p>
            </section>
            
            <section>
                <h3>Stellungsanalyse</h3>
                <img src="IMG-20260205-WA0000.jpg" alt="Schachstellung">
                <p style="font-size: 0.5em; color: #2196F3;">Audio aktiv</p>
            </section>

            <section>
                <h1>Vorbereitung AR</h1>
                <p>Bitte halte dein Smartphone bereit.</p>
            </section>

            <section>
                <h3>AR Live-Modell</h3>
                <div class="ar-container">
                    <model-viewer 
                        src="https://modelviewer.dev/shared-assets/models/Cube.gltf"
                        ios-src="https://modelviewer.dev/shared-assets/models/Cube.gltf"
                        ar 
                        ar-modes="webxr scene-viewer quick-look" 
                        camera-controls 
                        auto-rotate 
                        shadow-intensity="1"
                        alt="3D Würfel">
                        
                        <button slot="ar-button" class="ar-button">
                            WÜRFEL IM RAUM PLATZIEREN
                        </button>
                    </model-viewer>
                </div>
                <p style="font-size: 0.4em; color: #888; margin-top: 10px;">
                    Hinweis: AR erfordert ein Smartphone und eine HTTPS-Verbindung.
                </p>
            </section>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script src="config.js"></script>

    <script>
        // 1. Reveal.js initialisieren
        const deck = new Reveal();
        deck.initialize({ 
            controls: false, 
            progress: true, 
            hash: false, 
            touch: false, // Zuschauer kann nicht selbst wischen
            transition: 'slide' 
        });
        
        const audio = document.getElementById("sync-audio");
        const statusTxt = document.getElementById("st-txt");
        let pubnub;

        // 2. Start-Funktion
        async function initViewer() {
            document.getElementById("start-overlay").style.display = 'none';
            statusTxt.innerText = "Verbinde...";

            // Audio "freischalten"
            try { 
                await audio.play(); 
                audio.pause(); 
                audio.currentTime = 0; 
            } catch (e) { console.log("Audio braucht Benutzerklick"); }

            // PubNub Setup
            pubnub = new PubNub({
                subscribeKey: Pub_Nub_api_Subscribe,
                userId: "user_" + Math.random().toString(36).substring(7)
            });

            pubnub.addListener({
                status: (s) => {
                    if (s.category === "PNConnectedCategory") {
                        statusTxt.innerText = "LIVE";
                        statusTxt.style.color = "#00ff00";
                        fetchState(); // Letzten Stand holen
                    }
                },
                message: (m) => handleMessage(m.message)
            });

            pubnub.subscribe({ channels: [My_Channel_Name] });
        }

        // 3. Letzten Stand der Präsentation abfragen
        function fetchState() {
            pubnub.fetchMessages({ channels: [My_Channel_Name], count: 1 }, (s, r) => {
                if (r && r.channels[My_Channel_Name]) {
                    handleMessage(r.channels[My_Channel_Name][0].message);
                }
            });
        }

        // 4. Nachrichten verarbeiten
        function handleMessage(msg) {
            // Folienwechsel
            if (msg.index !== undefined) {
                deck.slide(msg.index);
            }

            // Audio-Sync (Nur Folie Index 1)
            if (msg.index === 1 && msg.startTime) {
                syncAudio(msg.startTime);
            } else {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        // 5. Präziser Audio-Sync
        function syncAudio(startTime) {
            pubnub.time().then((t) => {
                const serverNow = Math.floor(t.timetoken / 10000);
                const elapsed = (serverNow - startTime) / 1000; // in Sekunden

                if (elapsed >= 0 && elapsed < audio.duration) {
                    audio.currentTime = elapsed;
                    audio.play().catch(e => console.log("Audio blockiert"));
                }
            });
        }
    </script>
</body>
</html>
