<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Torva Viewer - Structure Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/black.min.css">

    <style>
        :root { 
            --neon-blue: #00f2ff; 
            --neon-purple: #bc13fe; 
            --matrix-green: #00ff41; 
            --damage-red: #ff0055; /* Umbenannt für Klarheit */
            --bg-deep: #050505; 
        }
        body { background: var(--bg-deep); overflow: hidden; font-family: 'Courier New', monospace; margin: 0; }
        
        #background-layer { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            display: flex; justify-content: center; align-items: center; 
            z-index: 1; perspective: 1200px; 
        }

        .morph-grid {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
            gap: 4px; width: 75vmin; height: 75vmin;
            transition: transform 1s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d;
        }

        .cell { 
            width: 100%; height: 100%; 
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); 
            position: relative; border-radius: 2px; 
            opacity: 0.1; 
            background: #333;
        }

        /* --- GO MODE --- */
        .mode-go .cell { border-radius: 50%; opacity: 1; transform: scale(0.85); }
        .mode-go .cell.black { background: #111; box-shadow: inset 2px 2px 5px rgba(255,255,255,0.1); }
        .mode-go .cell.white { background: #eee; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .mode-go .cell.empty { opacity: 0.05; background: #fff; }

        /* --- QR STRUCTURE HIGHLIGHTS --- */
        
        /* Basis für alle QR Zellen */
        .mode-qr .cell { transform: scale(0.95); border-radius: 0; }

        /* 1. FINDER PATTERNS (Position) - Blau */
        .cell.is-finder { background: var(--neon-blue); }
        .highlight-finders .cell.is-finder { 
            opacity: 1; 
            box-shadow: 0 0 20px var(--neon-blue); 
            z-index: 10;
        }

        /* 2. SYNC / TIMING PATTERNS - Grün */
        .cell.is-sync { background: var(--matrix-green); border-radius: 50%; }
        .highlight-sync .cell.is-sync { 
            opacity: 1; 
            box-shadow: 0 0 15px var(--matrix-green); 
            transform: scale(0.6);
        }

        /* 3. VERSION DATA - Lila */
        .cell.is-version { background: var(--neon-purple); }
        .highlight-version .cell.is-version { 
            opacity: 1; 
            box-shadow: 0 0 15px var(--neon-purple); 
            transform: scale(0.8) rotate(45deg);
        }

        /* 4. DATA & BITS (Das hier wurde geändert) */
        .cell.is-data { background: #eee; opacity: 0.8; } /* Inaktive Hintergrundzellen (weiß/grau) */
        
        /* Aktive Bits (die eigentlichen Datenpunkte) werden wieder Neon-Blau */
        .cell.bit-1 { 
            background: var(--neon-blue) !important; 
            box-shadow: 0 0 5px var(--neon-blue) !important;
            opacity: 1 !important;
        }

        /* Full Mode Resets für saubere Darstellung */
        .highlight-full .cell { opacity: 1; }
        .highlight-full .cell.is-sync:not(.bit-1) { background: #eee; transform: scale(0.95); border-radius: 0; }
        .highlight-full .cell.is-version:not(.bit-1) { background: #eee; transform: scale(0.95); rotate: 0deg; }


        /* Dimming Logic */
        .cell.dimmed { opacity: 0.05 !important; transform: scale(0.5) !important; box-shadow: none !important; }

        /* --- DAMAGE (Das hier wurde geändert) --- */
        .cell.damaged { 
            background: var(--damage-red) !important; 
            box-shadow: 0 0 15px var(--damage-red) !important; 
            opacity: 1 !important; 
            z-index: 20;
            /* Animation entfernt, jetzt statisch */
        }
        /* @keyframes glitch entfernt */


        /* Video & AR */
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background: black; opacity: 0; pointer-events: none; transition: opacity 0.5s; display: flex; justify-content: center; align-items: center; }
        #video-container.active { opacity: 1; pointer-events: all; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #ar-viewer-container { width: 100%; height: 80vh; background: #222; border-radius: 20px; overflow: hidden; position: relative; }
        model-viewer { width: 100%; height: 100%; }
        #btn-start { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid var(--neon-blue); color: var(--neon-blue); background: rgba(0,0,0,0.9); padding: 20px 40px; font-size: 1.5rem; cursor: pointer; z-index: 100; font-family: sans-serif; text-transform: uppercase; letter-spacing: 3px; }
    </style>
</head>
<body>
    <button id="btn-start" onclick="initSystem()">Initialize System</button>
    <div id="video-container"><video id="main-video" playsinline><source src="qr-code-pubnub-torva-project.mp4" type="video/mp4"></video></div>
    <div id="background-layer"><div id="grid" class="morph-grid mode-go"></div></div>

    <div class="reveal"><div class="slides">
        <section data-state="state-go"></section>
        <section data-state="state-qr"></section>
        <section data-state="state-ar">
            <div id="ar-viewer-container">
                <model-viewer src="https://modelviewer.dev/shared-assets/models/Astronaut.glb" ar camera-controls auto-rotate shadow-intensity="1"></model-viewer>
            </div>
        </section>
    </div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script>
        const deck = new Reveal();
        deck.initialize({ controls: false, progress: false, hash: false, transition: 'fade' });
        
        const grid = document.getElementById('grid');
        const cells = [];
        const gridSize = 15;

        // Init Grid
        for(let i=0; i<gridSize*gridSize; i++) {
            let div = document.createElement('div');
            div.className = 'cell';
            grid.appendChild(div);
            cells.push(div);
        }

        function clearClasses() {
            grid.classList.remove('mode-go', 'mode-qr', 'highlight-finders', 'highlight-sync', 'highlight-version', 'highlight-full');
            cells.forEach(c => {
                c.className = 'cell'; 
            });
        }

        function renderGo() {
            clearClasses();
            grid.classList.add('mode-go');
            cells.forEach(c => {
                let r = Math.random();
                if(r > 0.8) c.classList.add('black');
                else if(r > 0.6) c.classList.add('white');
                else c.classList.add('empty');
            });
        }

        function identifyCellType(x, y) {
            if ((x < 4 && y < 4) || (x > 10 && y < 4) || (x < 4 && y > 10)) return 'is-finder';
            if ((y === 2 && x >= 4 && x <= 10) || (x === 2 && y >= 4 && y <= 10)) return 'is-sync';
            if ((y === 4 && x < 4) || (x === 4 && y < 4)) return 'is-version';
            if (y === 4 && x > 10) return 'is-version';
            if (x === 4 && y > 10) return 'is-version';
            return 'is-data';
        }

        function renderQRStructure(highlightMode) {
            grid.classList.remove('highlight-finders', 'highlight-sync', 'highlight-version', 'highlight-full');
            
            if(!grid.classList.contains('mode-qr')) {
                clearClasses();
                grid.classList.add('mode-qr');
                cells.forEach((c, i) => {
                    const x = i % gridSize; 
                    const y = Math.floor(i / gridSize);
                    const type = identifyCellType(x, y);
                    c.classList.add(type);

                    // Zufällige Bits generieren
                    if (type === 'is-data' || type === 'is-version' || type === 'is-sync') {
                        if (Math.random() > 0.5) {
                            c.classList.add('bit-1'); // Wird jetzt blau im CSS
                        }
                    }
                });
            }

            if(highlightMode) grid.classList.add(highlightMode);

            cells.forEach(c => {
                c.classList.remove('dimmed');
                
                if (highlightMode !== 'highlight-full') {
                    if (highlightMode === 'highlight-finders' && !c.classList.contains('is-finder')) c.classList.add('dimmed');
                    if (highlightMode === 'highlight-sync' && !c.classList.contains('is-sync')) c.classList.add('dimmed');
                    if (highlightMode === 'highlight-version' && !c.classList.contains('is-version')) c.classList.add('dimmed');
                }
            });
        }

        function initSystem() {
            document.getElementById('btn-start').style.display = 'none';
            const videoPlayer = document.getElementById('main-video');
            
            const pubnub = new PubNub({ subscribeKey: 'sub-c-6fdfc9e3-91b8-4f79-b62a-6fd9fc69eff7', userId: "v15-viewer" });
            
            pubnub.addListener({
                message: (m) => {
                    const msg = m.message;
                    if(msg.slide !== undefined) deck.slide(msg.slide);
                    
                    if(msg.action === 'morph_go') renderGo();
                    
                    if(msg.action === 'highlight_finders') renderQRStructure('highlight-finders');
                    if(msg.action === 'highlight_sync') renderQRStructure('highlight-sync');
                    if(msg.action === 'highlight_version') renderQRStructure('highlight-version');
                    if(msg.action === 'morph_qr') renderQRStructure('highlight-full'); 

                    if(msg.action === 'damage') {
                        // Wir beschädigen nur blaue Zellen (bit-1) für besseren Effekt
                        let dataCells = cells.filter(c => c.classList.contains('bit-1'));
                        for(let i=0; i<20; i++) { 
                            if(dataCells.length > 0) {
                                let rng = Math.floor(Math.random()*dataCells.length);
                                dataCells[rng].classList.add('damaged');
                            }
                        }
                    }
                    if(msg.action === 'heal') {
                        cells.forEach(c => c.classList.remove('damaged'));
                        renderQRStructure('highlight-full');
                    }
                    
                    if(msg.action === 'video_sync') {
                        const container = document.getElementById('video-container');
                        if(msg.videoState === 'play') {
                            container.classList.add('active');
                            videoPlayer.currentTime = (Date.now() - msg.startTime) / 1000;
                            videoPlayer.play();
                        } else {
                            container.classList.remove('active');
                            videoPlayer.pause();
                        }
                    }
                }
            });
            
            pubnub.subscribe({ channels: ['PrasiW.Woche'] });
            renderGo();
        }
    </script>
</body>
</html>
