<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Live Präsentation - AR & Sync Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/black.min.css">

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        body { margin: 0; background: #000; }
        #status-bar { position: fixed; top: 10px; right: 10px; z-index: 100; padding: 6px 12px; background: rgba(0,0,0,0.8); border-radius: 20px; font-family: sans-serif; font-size: 11px; color: white; border: 1px solid #444; }
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-family: sans-serif; }
        #start-btn { padding: 18px 45px; background: #2196F3; color: white; border: none; border-radius: 40px; font-size: 20px; font-weight: bold; cursor: pointer; }

        /* AR Bereich */
        .ar-slide-container { width: 100%; height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        model-viewer {
            width: 90%;
            height: 400px;
            background-color: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            --poster-color: transparent;
        }

        /* Der AR-Aktivierungs-Button */
        .ar-button {
            background-image: url(https://modelviewer.dev/shared-assets/icons/ar_icon.png);
            background-repeat: no-repeat;
            background-size: 20px 20px;
            background-position: 12px 50%;
            background-color: #fff;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            bottom: 16px;
            padding: 0px 16px 0px 40px;
            font-family: Roboto Regular, Helvetica Neue, sans-serif;
            font-size: 14px;
            color:#4285f4;
            height: 36px;
            line-height: 36px;
            border-radius: 18px;
            border: 1px solid #DADCE0;
            display: block;
            z-index: 999;
            cursor: pointer;
        }

        .reveal img { max-height: 400px !important; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h2>Präsentation beitreten</h2>
        <button id="start-btn" onclick="initViewer()">START</button>
    </div>

    <div id="status-bar">Status: <span id="st-txt">Warte...</span></div>
    <audio id="sync-audio" src="morse (2).mp3" preload="auto"></audio>

    <div class="reveal">
        <div class="slides">
            
            <section><h1>Willkommen</h1><p>Gleich geht es los.</p></section>
            
            <section>
                <h3>Stellungsanalyse</h3>
                <img src="IMG-20260205-WA0000.jpg">
                <p>Audio-Sync aktiv.</p>
            </section>

            <section><h1>AR Vorbereitung</h1><p>Bitte jetzt das Handy nutzen.</p></section>

            <section>
                <div class="ar-slide-container">
                    <h3>Live AR Modell</h3>
                    
                    <model-viewer 
                        id="ar-element"
                        src="https://modelviewer.dev/shared-assets/models/Astronaut.glb" 
                        ar 
                        ar-modes="webxr scene-viewer quick-look" 
                        camera-controls 
                        poster="https://modelviewer.dev/shared-assets/models/poster-astronaut.png"
                        shadow-intensity="1" 
                        auto-rotate>
                        
                        <button slot="ar-button" class="ar-button">
                            IN DEINEM RAUM ANSEHEN
                        </button>

                        <div id="ar-failure" style="display:none; color: red; position: absolute; bottom: 10px;">
                            AR nicht unterstützt auf diesem Gerät.
                        </div>
                    </model-viewer>
                    
                    <p style="font-size: 0.4em; margin-top: 20px;">
                        Tippe auf den Button oben, um die Kamera zu öffnen.
                    </p>
                </div>
            </section>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script src="config.js"></script>

    <script>
        const deck = new Reveal();
        deck.initialize({ controls: false, progress: true, hash: false, touch: false });
        
        const audio = document.getElementById("sync-audio");
        const statusTxt = document.getElementById("st-txt");
        let pubnub;

        // Fehlerbehandlung für AR
        document.querySelector('#ar-element').addEventListener('ar-status', (event) => {
            if (event.detail.status === 'failed') {
                document.querySelector('#ar-failure').style.display = 'block';
            }
        });

        async function initViewer() {
            document.getElementById("start-overlay").style.display = 'none';
            statusTxt.innerText = "Verbinde...";

            try { await audio.play(); audio.pause(); audio.currentTime = 0; } catch (e) {}

            pubnub = new PubNub({
                subscribeKey: Pub_Nub_api_Subscribe,
                userId: "user_" + Math.random().toString(36).substring(7)
            });

            pubnub.addListener({
                status: (s) => {
                    if (s.category === "PNConnectedCategory") {
                        statusTxt.innerText = "LIVE";
                        statusTxt.style.color = "#00ff00";
                        fetchState();
                    }
                },
                message: (m) => handleMessage(m.message)
            });

            pubnub.subscribe({ channels: [My_Channel_Name] });
        }

        function fetchState() {
            pubnub.fetchMessages({ channels: [My_Channel_Name], count: 1 }, (s, r) => {
                if (r && r.channels[My_Channel_Name]) {
                    handleMessage(r.channels[My_Channel_Name][0].message);
                }
            });
        }

        function handleMessage(msg) {
            if (msg.index !== undefined) deck.slide(msg.index);
            if (msg.index === 1 && msg.startTime) {
                syncAudio(msg.startTime);
            } else {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        function syncAudio(startTime) {
            pubnub.time().then((t) => {
                const serverNow = Math.floor(t.timetoken / 10000);
                const elapsed = (serverNow - startTime) / 1000;
                if (elapsed >= 0 && elapsed < audio.duration) {
                    audio.currentTime = elapsed;
                    audio.play().catch(e => console.log("Audio locked"));
                }
            });
        }
    </script>
</body>
</html>
