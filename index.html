<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Torva Viewer - Fixed Patterns</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/black.min.css">

    <style>
        :root { 
            --neon-blue: #00f2ff; 
            --neon-purple: #bc13fe; 
            --matrix-green: #00ff41; 
            --damage-red: #ff0055; 
            --bg-deep: #000000; 
            --qr-on: #00f2ff;  /* Daten AN = Blau */
            --qr-off: #000000; /* Daten AUS = Schwarz (KEIN WEISS) */
        }
        
        body { background: var(--bg-deep); overflow: hidden; font-family: 'Courier New', monospace; margin: 0; }
        
        #background-layer { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            display: flex; justify-content: center; align-items: center; 
            z-index: 1; perspective: 1200px; 
        }

        .morph-grid {
            display: grid;
            grid-template-columns: repeat(21, 1fr);
            grid-template-rows: repeat(21, 1fr);
            gap: 2px;
            width: 80vmin; height: 80vmin;
            transition: transform 1s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d;
        }

        .cell { 
            width: 100%; height: 100%; 
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); 
            position: relative; border-radius: 2px; 
            background: #222;
        }

        /* --- MODE: GO (Obsidian) --- */
        .mode-go .cell { border-radius: 50%; transform: scale(0.9); opacity: 1; }
        .mode-go .cell.black { 
            background: radial-gradient(circle at 35% 35%, #444, #000 60%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.8), inset 1px 1px 2px rgba(255,255,255,0.1);
        }
        .mode-go .cell.white { 
            background: radial-gradient(circle at 30% 30%, #fff, #bbb);
            box-shadow: 0 0 10px rgba(255,255,255,0.2); 
        }
        .mode-go .cell.empty { opacity: 0.05; background: #fff; }

        /* --- MODE: QR CODE (Strict Black/Blue) --- */
        .mode-qr .cell { transform: scale(1); border-radius: 0; opacity: 1; }
        
        /* 1. Finder Patterns (Die großen Quadrate) */
        .mode-qr .cell.finder-outer { background: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 242, 255, 0.4); z-index: 5; }
        .mode-qr .cell.finder-inner { background: #000; } /* Innen schwarz */
        .mode-qr .cell.finder-center { background: var(--neon-blue); box-shadow: 0 0 20px rgba(0, 242, 255, 0.8); }
        
        /* 2. Format Info (Ersetzt Version für 21x21 Grid) */
        /* Das sind die Streifen direkt neben den Findern */
        .mode-qr .cell.is-format { background: var(--neon-purple); z-index: 6; }
        
        /* 3. Timing Patterns (Sync) */
        .mode-qr .cell.is-sync.bit-1 { background: var(--matrix-green); box-shadow: 0 0 10px var(--matrix-green); z-index: 6; }
        .mode-qr .cell.is-sync.bit-0 { background: #000; }
        
        /* 4. Data Payload */
        .mode-qr .cell.is-data.bit-1 { background: var(--qr-on); opacity: 1; }
        .mode-qr .cell.is-data.bit-0 { background: var(--qr-off); opacity: 1; } 

        /* --- HIGHLIGHT MODES (Dimmen des Rests) --- */
        
        /* Highlight Finder */
        .highlight-finders .cell:not(.finder-outer):not(.finder-inner):not(.finder-center) { 
            opacity: 0.1; transform: scale(0.5); filter: grayscale(100%); 
        }
        .highlight-finders .cell.finder-outer { transform: scale(1.1); }

        /* Highlight Sync */
        .highlight-sync .cell { opacity: 0.1; transform: scale(0.5); }
        .highlight-sync .cell.is-sync { opacity: 1; transform: scale(1.2); border-radius: 2px; }
        .highlight-sync .cell.finder-outer, .highlight-sync .cell.finder-inner, .highlight-sync .cell.finder-center { opacity: 0.3; }

        /* Highlight Format (Version) */
        .highlight-version .cell { opacity: 0.1; transform: scale(0.5); }
        .highlight-version .cell.is-format { opacity: 1; transform: scale(1.1); box-shadow: 0 0 10px var(--neon-purple); }

        /* Damage FX */
        .cell.damaged { background: var(--damage-red) !important; box-shadow: 0 0 20px var(--damage-red) !important; animation: glitch 0.2s infinite; z-index: 50; }
        @keyframes glitch { 0% {transform: translate(0)} 20% {transform: translate(-2px, 2px)} 40% {transform: translate(2px, -2px)} 100% {transform: translate(0)} }

        /* Video Layer */
        #video-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; 
            background: black; opacity: 0; pointer-events: none; transition: opacity 0.5s; 
            display: flex; justify-content: center; align-items: center; 
        }
        #video-container.active { opacity: 1; pointer-events: all; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* AR Container - Fix für Verschwinden */
        #ar-wrapper {
            width: 100%; height: 80vh; 
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        
        model-viewer { 
            width: 100%; height: 100%; 
            background: #111; border-radius: 12px;
            --poster-color: transparent;
        }

        /* Custom AR Button Style */
        .ar-button-custom {
            background-color: #000;
            border-radius: 4px;
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
            z-index: 100;
        }
        .ar-button-custom:active { transform: scale(0.95); }

        #btn-start { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            border: 2px solid var(--neon-blue); color: var(--neon-blue); 
            background: rgba(0,0,0,0.9); padding: 20px 40px; font-size: 1.5rem; 
            cursor: pointer; z-index: 100; font-family: sans-serif; 
            text-transform: uppercase; letter-spacing: 3px; 
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }
    </style>
</head>
<body>
    <button id="btn-start" onclick="initSystem()">INITIALIZE SYSTEM</button>
    
    <div id="video-container">
        <video id="main-video" playsinline webkit-playsinline preload="auto">
            <source src="qr-code-pubnub-torva-project.mp4" type="video/mp4">
        </video>
    </div>
    
    <div id="background-layer"><div id="grid" class="morph-grid mode-go"></div></div>

    <div class="reveal"><div class="slides">
        <section data-state="state-go"></section>
        <section data-state="state-qr"></section>
        <section data-state="state-ar">
            <div id="ar-wrapper">
                <model-viewer 
                    src="https://modelviewer.dev/shared-assets/models/Astronaut.glb" 
                    ar 
                    ar-modes="webxr scene-viewer quick-look" 
                    camera-controls 
                    auto-rotate 
                    shadow-intensity="1"
                    interaction-prompt="auto">
                    
                    <button slot="ar-button" class="ar-button-custom">
                        ACTIVATE AR VIEW
                    </button>
                </model-viewer>
            </div>
        </section>
    </div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.3.min.js"></script>
    <script>
        const deck = new Reveal();
        deck.initialize({ controls: false, progress: false, hash: false, transition: 'fade' });
        
        const grid = document.getElementById('grid');
        const cells = [];
        const gridSize = 21; 

        // Init Grid
        for(let i=0; i<gridSize*gridSize; i++) {
            let div = document.createElement('div');
            div.className = 'cell';
            grid.appendChild(div);
            cells.push(div);
        }

        function clearClasses() {
            grid.classList.remove('mode-go', 'mode-qr', 'highlight-finders', 'highlight-sync', 'highlight-version');
            cells.forEach(c => c.className = 'cell');
        }

        function renderGo() {
            clearClasses();
            grid.classList.add('mode-go');
            cells.forEach(c => {
                let r = Math.random();
                if(r > 0.8) c.classList.add('black');
                else if(r > 0.6) c.classList.add('white');
                else c.classList.add('empty');
            });
        }

        // --- Korrigierte QR Logik (Version 1, 21x21) ---
        function identifyCellType(x, y) {
            // 1. Finder Patterns (7x7 in den Ecken)
            // Oben Links
            if (x < 7 && y < 7) {
                if ((x===0||x===6) && y<=6) return 'finder-outer';
                if ((y===0||y===6) && x<=6) return 'finder-outer';
                if ((x>=2&&x<=4) && (y>=2&&y<=4)) return 'finder-center';
                return 'finder-inner'; // Der Spalt dazwischen
            }
            // Oben Rechts
            if (x > 13 && y < 7) {
                if ((x===14||x===20) && y<=6) return 'finder-outer';
                if ((y===0||y===6) && x>=14) return 'finder-outer';
                if ((x>=16&&x<=18) && (y>=2&&y<=4)) return 'finder-center';
                return 'finder-inner';
            }
            // Unten Links
            if (x < 7 && y > 13) {
                if ((x===0||x===6) && y>=14) return 'finder-outer';
                if ((y===14||y===20) && x<=6) return 'finder-outer';
                if ((x>=2&&x<=4) && (y>=16&&y<=18)) return 'finder-center';
                return 'finder-inner';
            }

            // 2. Timing Patterns (Sync)
            // Verbindet die Finder horizontal und vertikal auf Index 6
            // Aber nur wo keine Finder sind (also x von 8 bis 12, y von 8 bis 12)
            if (y === 6 && x >= 8 && x <= 12) return 'is-sync';
            if (x === 6 && y >= 8 && y <= 12) return 'is-sync';

            // 3. Format Information (Nicht Version Info in V1, aber wir nutzen das als "Version"-Highlight)
            // Die Streifen direkt neben den Findern
            // Horizontal neben Oben-Links Finder
            if (y === 8 && ((x <= 8) || (x >= 14))) return 'is-format';
            // Vertikal neben Oben-Links Finder
            if (x === 8 && ((y <= 8) || (y >= 14))) return 'is-format';
            
            // Ein einzelner "Dark Module" Punkt (Definiert in QR Specs)
            if (x === 8 && y === 13) return 'is-data'; // Normal data coloring for aesthetics

            // 4. Alles andere ist Data
            return 'is-data';
        }

        function renderQRStructure(highlightMode = null) {
            grid.classList.remove('highlight-finders', 'highlight-sync', 'highlight-version');
            
            if(!grid.classList.contains('mode-qr')) {
                clearClasses();
                grid.classList.add('mode-qr');
                
                cells.forEach((c, i) => {
                    const x = i % gridSize; 
                    const y = Math.floor(i / gridSize);
                    const type = identifyCellType(x, y);
                    c.classList.add(type);

                    // Color Logic
                    if (type === 'is-data' || type === 'is-format') {
                        // Zufällige Daten (Blau/Schwarz)
                        c.classList.add(Math.random() > 0.5 ? 'bit-1' : 'bit-0');
                    } else if (type === 'is-sync') {
                        // Timing muss strikt alternieren (Schwarz/Weiß bzw. Schwarz/Grün)
                        // Da QR Specs sagen: Schwarz auf geraden Indexen (innerhalb des Sync Bereichs)
                        let isBlack = (x === 6 ? y : x) % 2 === 0;
                        c.classList.add(isBlack ? 'bit-1' : 'bit-0'); // bit-1 hier ist grün highlight
                    }
                });
            }

            if(highlightMode) grid.classList.add(highlightMode);
        }

        function initSystem() {
            document.getElementById('btn-start').style.display = 'none';
            const videoPlayer = document.getElementById('main-video');
            
            videoPlayer.muted = false;
            videoPlayer.play().then(() => {
                videoPlayer.pause();
                videoPlayer.currentTime = 0;
            }).catch(e => {
                videoPlayer.muted = true;
            });

            const pubnub = new PubNub({ subscribeKey: 'sub-c-6fdfc9e3-91b8-4f79-b62a-6fd9fc69eff7', userId: "v16-viewer" });
            
            pubnub.addListener({
                message: (m) => {
                    const msg = m.message;
                    if(msg.slide !== undefined) deck.slide(msg.slide);
                    
                    if(msg.action === 'morph_go') renderGo();
                    if(msg.action === 'morph_qr') renderQRStructure(); 
                    if(msg.action === 'highlight_finders') renderQRStructure('highlight-finders');
                    if(msg.action === 'highlight_sync') renderQRStructure('highlight-sync');
                    if(msg.action === 'highlight_version') renderQRStructure('highlight-version');
                    
                    if(msg.action === 'damage') {
                        let dataCells = cells.filter(c => c.classList.contains('is-data') && c.classList.contains('bit-1'));
                        for(let i=0; i<15; i++) if(dataCells.length > 0) dataCells[Math.floor(Math.random()*dataCells.length)].classList.add('damaged');
                    }
                    if(msg.action === 'heal') {
                        cells.forEach(c => c.classList.remove('damaged'));
                        renderQRStructure();
                    }
                    
                    if(msg.action === 'video_sync') {
                        const container = document.getElementById('video-container');
                        if(msg.videoState === 'play') {
                            container.classList.add('active');
                            let targetTime = ((Date.now() - msg.startTime) / 1000) + 0.1; 
                            if (targetTime < 0) targetTime = 0;
                            let drift = Math.abs(videoPlayer.currentTime - targetTime);
                            if (drift > 0.6 || videoPlayer.paused) videoPlayer.currentTime = targetTime;
                            if(videoPlayer.paused) videoPlayer.play().catch(e => { videoPlayer.muted = true; videoPlayer.play(); });
                        } else {
                            container.classList.remove('active');
                            videoPlayer.pause();
                        }
                    }
                }
            });
            
            pubnub.subscribe({ channels: ['PrasiW.Woche'] });
            renderGo();
        }
    </script>
</body>
</html>
